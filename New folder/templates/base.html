{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CA Track</title>
  <link rel="icon" href="{% static 'favicon.svg' %}" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
</head>
<body>
  <header class="topbar">
    <a href="/" class="brand">CA Track</a>
    <nav class="nav">
      <a href="/" class="nav-link">Dashboard</a>
      <a href="/projects/" class="nav-link">Projects</a>
      <a href="/submittals/" class="nav-link">Submittals</a>
      <a href="/rfis/" class="nav-link">RFIs</a>
    </nav>
    <div class="spacer"></div>
    <button id="themeToggle" class="btn btn-ghost" title="Toggle theme">‚òæ</button>
    {% if request.user.is_authenticated %}
      <div class="user-chip">{{ request.user.get_full_name|default:request.user.username }}</div>
      <a class="btn btn-ghost" href="/logout/">Logout</a>
    {% else %}
      <a class="btn btn-primary" href="/login/">Login</a>
    {% endif %}
  </header>
  <div class="app-grid">
    <aside class="sidebar">
      <nav class="side-nav">
        <a href="/" class="side-link">üè† Dashboard</a>
        <a href="/projects/" class="side-link">üìÅ Projects</a>
        <a href="/submittals/" class="side-link">üìë Submittals</a>
        <a href="/rfis/" class="side-link">‚ùì RFIs</a>
      </nav>
    </aside>
    <main class="container">
      {% block content %}{% endblock %}
    </main>
  </div>
  <div id="toasts" aria-live="polite" aria-atomic="true"></div>
  <script>
    function _caToggleReturned(container){
      try{
        const select = container.querySelector('select[name="to_status"]');
        const wrap = container.querySelector('[data-returned-date]');
        const input = container.querySelector('input[name="date_returned"]');
        const update = ()=>{
          const isRet = select && select.value === 'RETURNED';
          if(wrap){ wrap.style.display = isRet ? '' : 'none'; }
          if(isRet && input && !input.value){
            const t=new Date();
            const m=String(t.getMonth()+1).padStart(2,'0');
            const d=String(t.getDate()).padStart(2,'0');
            input.value = `${t.getFullYear()}-${m}-${d}`;
          }
        };
        if(select){ select.addEventListener('change', update); update(); }
      }catch(e){ /* no-op */ }
    }
    function _caToggleResponded(container){
      try{
        const select = container.querySelector('select[name="to_status"]');
        const wrap = container.querySelector('[data-responded-date]');
        const input = container.querySelector('input[name="date_responded"]');
        const update = ()=>{
          const isClosed = select && select.value === 'CLOSED';
          if(wrap){ wrap.style.display = isClosed ? '' : 'none'; }
          if(isClosed && input && !input.value){
            const t=new Date();
            const m=String(t.getMonth()+1).padStart(2,'0');
            const d=String(t.getDate()).padStart(2,'0');
            input.value = `${t.getFullYear()}-${m}-${d}`;
          }
        };
        if(select){ select.addEventListener('change', update); update(); }
      }catch(e){ /* no-op */ }
    }
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('[data-toggle-returned]').forEach(_caToggleReturned);
      document.querySelectorAll('[data-toggle-responded]').forEach(_caToggleResponded);
    });
    document.addEventListener('htmx:afterSwap', function(evt){
      if(evt.target){
        evt.target.querySelectorAll('[data-toggle-returned]').forEach(_caToggleReturned);
        evt.target.querySelectorAll('[data-toggle-responded]').forEach(_caToggleResponded);
      }
    });
  </script>
  <script src="{% static 'js/app.js' %}"></script>
</body>
</html>
